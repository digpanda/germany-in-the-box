:javascript
  $( document ).ready( function () {
    $.widget( 'custom.catcomplete', $.ui.autocomplete, {
      _create: function() {
          this._super();
          this.widget().menu( 'option', 'items', '> :not(.ui-autocomplete-category)' );
      },
      _renderMenu: function( ul, items ) {
          var that = this,
              search_category = '';
          $.each( items, function( index, item ) {
              var li;
              if ( item.sc != search_category ) {
                  ul.append( "<li class='ui-autocomplete-category'>" + item.sc + '</li>' );
                  search_category = item.sc;
              }
              li = that._renderItemData( ul, item );
              if ( item.sc ) {
                  li.attr( 'aria-label', item.sc + ' : ' + item.label );
              }
          });
      }
    });

    $( '#products_search_keyword' ).catcomplete({
      delay: 1000,
      source: '/products/autocomplete_product_name',
      select: function (a, b) {
        $(this).val(b.item.value);
        $('#search_products_form').submit()
      }
    });
  });

- for_device_type :desktop do
  = content_for :search_area do
    = form_tag search_products_path, :method => :get, :id => 'search_products_form', :class => 'search-area' do
      .container
        .row
          .col-md-12.clearfix
            %label
              %i.fa.fa-search
              %span= I18n.t(:search_prompt, scope: :popular_products)
            .search-area-division.search-area-division-input
              =text_field_tag :products_search_keyword, params[:products_search_keyword], :placeholder => "#{ I18n.t(:search_placeholder, scope: :popular_products) }", :class => 'form-control'
.container
  - if @products.count == 0
    %h4 Products cannot be found.
  - else
    - for_device_type :mobile, :tablet do
      - @products.each do |p|
        .fotorama{'data-allowfullscreen' => '1', 'data-nav' => 'thumbs', 'data-thumbheight' => '96', "data-thumbwidth" => '96'}
          =image_tag p.img0.url
          =image_tag p.img1.url
          =image_tag p.img2.url
          =image_tag p.img3.url
        .product-info.box
          -if p.shop
            %h4=link_to "Shop: #{p.shop.name}", p.shop
          %h4= p.name
          %p.text-smaller.text-muted= p.desc
          %h5.product-info-price= "$#{p.price}"

          .btn-toolbar
            .col-xs-4
              = form_tag add_product_to_orders_path, :method => :patch do
                = hidden_field_tag :product_id, "#{p.id}"
                - if enough_inventory(p.id, 1)
                  %button.btn.btn-primary.btn-small{ :type => 'submit', :title => "#{I18n.t(:add_to_cart, scope: :popular_products)}" }
                  %i.fa.fa-shopping-cart
                - else   
                  %button.btn.btn-primary.btn-small{ :type => 'submit', :title => "#{I18n.t(:add_to_cart, scope: :popular_products)}", :disabled => true }
                  %i.fa.fa-shopping-cart

            .col-xs-4
              - if user_signed_in?
                .dropdown
                  %a.btn.dropdown-toggle.btn-small{:id => "dropdown_toggle_#{p.id}", 'data-toggle' => 'dropdown', :type => 'button', :class => "#{in_user_collections?(p) ? 'btn-success' : 'btn-primary' }", :title => "#{I18n.t(:add_to_favorite, scope: :popular_products)}" }
                    %i.fa.fa-heart
                    %span.caret
                  %ul.dropdown-menu.scrollable-menu
                    - current_user.oCollections.each do |c|
                      %li
                        %label
                          = check_box_tag "collection_checkbox_#{c.id}", c.products.include?(p), c.products.include?(p), { :onclick => "#{generate_toggle_product_in_collection_js(c.id, p.id)}" }
                          %i{ :class => "#{c.public ? 'fa fa-users' : 'fa fa-user'}" }= c.name
              - else
                .dropdown
                  %a.btn.btn-default.btn-small{:href => '#', 'data-toggle' => 'dropdown', 'data-placement' => 'bottom', :title => "#{I18n.t(:add_to_favorite, scope: :popular_products)}" }
                    %i.fa.fa-heart
                    %span.caret
                  %btn.dropdown-menu
                    %li
                      .col-md-6
                        = link_to I18n.t(:sign_in, scope: :top_menu), user_session_path, :class => 'fa fa-sign-in', :style => 'color:black; text-decoration: underline'
                      .col-md-6
                        = link_to I18n.t(:sign_up, scope: :top_menu),  new_user_registration_path, :class => 'fa fa-edit', :style => 'color:black; text-decoration: underline'

            .col-xs-4
              - if user_signed_in?
                .dropdown
                  %a.btn.btn-primary.btn-small{ 'data-toggle' => 'dropdown', :id => "create_and_add_to_collection_dropdown_button_#{p.id}" , :title => "#{I18n.t(:create_and_add_to_favorite, scope: :popular_products)}" }
                    %i.fa.fa-share
                    %span.caret
                  %ul.dropdown-menu
                    %li
                      = form_tag '#', :style=>'min-width:300px;margin:4px', :id => "create_and_add_to_collection_form_#{p.id}" do
                        = text_field_tag 'collection[name]', nil, :placeholder => "#{I18n.t(:new_favorite, scope: :popular_products)}",  :id => "create_and_add_to_collection_form_input_name_#{p.id}", :autocomplete => :off
                        %label{ :style => 'margin:4px'}
                          = check_box_tag 'collection[public]'
                          %i.fa.fa-users{'data-toggle' => 'tooltip', 'data-placement' => 'bottom', :title => 'public' }
                        = hidden_field_tag :product_id, "#{p.id}"
                        =submit_tag I18n.t(:create_favorite, scope: :popular_products), :class => 'btn btn-primary', :onclick => "#{generate_create_and_add_to_collection_js(p.id)}"
              - else
                .dropdown
                  %a.btn.btn-default.btn-small{:href => '#', 'data-toggle' => 'dropdown', 'data-placement' => 'bottom', :title => "#{I18n.t(:create_and_add_to_favorite, scope: :popular_products)}" }
                    %i.fa.fa-share
                    %span.caret
                  %ul.dropdown-menu
                    %li{:style=>'min-width:250px'}
                      .col-md-6
                        = link_to I18n.t(:sign_in, scope: :top_menu), user_session_path, :class => 'fa fa-sign-in', :style => 'color:black; text-decoration: underline'
                      .col-md-6
                        = link_to  I18n.t(:sign_up, scope: :top_menu),  new_user_registration_path, :class => 'fa fa-edit', :style => 'color:black; text-decoration: underline'

    - for_device_type :desktop do
      - @products.each do |p|
        .mfp-with-anim.mfp-hide.mfp-dialog.mfp-dialog-big.clearfix{ :id => "product-quick-view-dialog-#{p.id}"}
          .row
            .col-md-8
              .fotorama{'data-allowfullscreen' => '1', 'data-nav' => 'thumbs', 'data-thumbheight' => '96', 'data-thumbwidth' => '96'}
                =image_tag p.img0.url
                =image_tag p.img1.url
                =image_tag p.img2.url
                =image_tag p.img3.url
            .col-md-4
              .product-page-meta
                -if p.shop
                  %h4=link_to "Shop: #{p.shop.name}", p.shop, :target => '_blank'
                %h4= p.name
                %p= p.desc
                = form_tag add_product_to_orders_path, :method => :patch do
                  = hidden_field_tag :product_id, "#{p.id}"
                  - if enough_inventory(p.id, 1)
                    = submit_tag "$#{p.price} #{I18n.t(:add_to_cart, scope: :popular_products)}", :class => 'btn btn-primary btn-lg btn-block'
                  - else    
                    = submit_tag "$#{p.price} #{I18n.t(:add_to_cart, scope: :popular_products)}", :class => 'btn btn-primary btn-lg btn-block', :disabled => true
                %ul.list.product-page-meta-info
                  %li
                    %ul.list.product-page-meta-price-list
                      %li
                        %span.product-page-meta-title= I18n.t(:price, scope: :popular_products)
                        %span.product-page-meta-price= "#{p.price} #{p.currency}"
                      %li
                        %span.product-page-meta-title= I18n.t(:discount, scope: :popular_products)
                        %span.product-page-meta-price= "#{p.discount}%"
                      %li
                        %span.product-page-meta-title= I18n.t(:saving, scope: :popular_products)
                        %span.product-page-meta-price= "#{p.price * p.discount} #{p.currency}"
                  -if p.limited      
                    %li
                      %ul.list.product-page-meta-price-list
                        %li
                          %span.product-page-meta-title= I18n.t(:inventory, scope: :popular_products)
                          %span.product-page-meta-price= p.inventory

          %hr
          .row
            .col-md-3
              - if user_signed_in?
                .dropdown
                  %button.btn.dropdown-toggle{:id => "dropdown_toggle_#{p.id}", 'data-toggle' => 'dropdown', :type => 'button', :class => "#{in_user_collections?(p) ? 'btn-success' : 'btn-primary' }"  }
                    %i.fa.fa-heart
                    = I18n.t(:add_to_favorite, scope: :popular_products)
                    %span.caret
                  %ul.dropdown-menu.scrollable-menu
                    - current_user.oCollections.each do |c|
                      %li
                        %label
                          = check_box_tag "collection_checkbox_#{c.id}", c.products.include?(p), c.products.include?(p), { :onclick => "#{generate_toggle_product_in_collection_js(c.id, p.id)}" }
                          %i{ :class => "#{c.public ? 'fa fa-users' : 'fa fa-user'}" }= c.name
              - else
                .dropdown
                  %a.btn.btn-default{:href => '#', 'data-toggle' => 'dropdown', 'data-placement' => 'bottom', :title => 'Yu haven\'t signed in' }
                    %i.fa.fa-heart
                    = I18n.t(:add_to_favorite, scope: :popular_products)
                    %span.caret
                  %ul.dropdown-menu
                    %li{:style=>'min-width:250px'}
                      .col-md-6
                        = link_to I18n.t(:sign_in, scope: :top_menu), user_session_path, :class => 'fa fa-sign-in', :style => 'color:black; text-decoration: underline'
                      .col-md-6
                        = link_to I18n.t(:sign_up, scope: :top_menu),  new_user_registration_path, :class => 'fa fa-edit', :style => 'color:black; text-decoration: underline'
            .col-md-3
              - if user_signed_in?
                .dropdown
                  %button.btn.btn-primary{ 'data-toggle' => 'dropdown', :id => "create_and_add_to_collection_dropdown_button_#{p.id}"  }
                    %i.fa.fa-share
                    = I18n.t(:create_and_add_to_favorite, scope: :popular_products)
                    %span.caret
                  %ul.dropdown-menu
                    %li
                      = form_tag '#', :style=>'min-width:300px;margin:4px', :id => "create_and_add_to_collection_form_#{p.id}" do
                        = text_field_tag 'collection[name]', nil, :placeholder => "#{I18n.t(:new_favorite, scope: :popular_products)}",  :id => "create_and_add_to_collection_form_input_name_#{p.id}", :autocomplete => :off
                        %label{ :style => 'margin:4px'}
                          = check_box_tag 'collection[public]', 'true', :checked => true
                          %i.fa.fa-users{'data-toggle' => 'tooltip', 'data-placement' => 'bottom', :title => 'public' }
                        = hidden_field_tag :product_id, "#{p.id}"
                        =submit_tag I18n.t(:create_favorite, scope: :popular_products), :class => 'btn btn-primary', :onclick => "#{generate_create_and_add_to_collection_js(p.id)}"
              - else
                .dropdown
                  %a.btn.btn-default{:href => '#', 'data-toggle' => 'dropdown', 'data-placement' => 'bottom', :title => 'Yu haven\'t signed in' }
                    %i.fa.fa-share
                    = I18n.t(:create_and_add_to_favorite, scope: :popular_products)
                    %span.caret
                  %ul.dropdown-menu
                    %li{:style=>'min-width:250px'}
                      .col-md-6
                        = link_to I18n.t(:sign_in, scope: :top_menu), user_session_path, :class => 'fa fa-sign-in', :style => 'color:black; text-decoration: underline'
                      .col-md-6
                        = link_to  I18n.t(:sign_up, scope: :top_menu),  new_user_registration_path, :class => 'fa fa-edit', :style => 'color:black; text-decoration: underline'
      .row
        .col-md-3
          %aside.sidebar-left
            %div#left_menu
              %ul
                %li#left_menu_header{ :class => 'has-sub active'}
                  %a{:href => '#' }
                    %i{ :class => 'fa fa-list' }= I18n.t(:categories, scope: :category)
                - @categories_and_children.keys.each do |c|
                  %li{ :class => 'has-sub' }
                    %a{:href => "#{show_products_in_category_path(c.id)}" }
                      %i{ :class => "fa #{c.cssc}" }= ' ' + c.name
                      %span= @categories_and_counters[c]
                    %ul
                      - @categories_and_children[c].each do |cc|
                        %li
                          %a{:href => "#{show_products_in_category_path(cc.id)}" }
                            %i= cc.name
                            %span= @categories_and_counters[cc]
        .col-md-9
          #masonry.row.row-wrap
            - @products.each do |p|
              %a.col-md-3.col-masonry.popup-text{'data-effect' => 'mfp-move-from-top', :href => "#product-quick-view-dialog-#{p.id}",  :shop_link => "#{p.shop ? shop_path(p.shop) : ''}"}
                .product-thumb
                  %header.product-header
                    = image_tag  p.img0.url, :alt => p.name, :title => p.name
                    .product-quick-view
                      %span.fa.fa-eye
                  .product-inner
                    %h5.product-title= truncate(p.name, :length => 16)
                    .product-desciption= truncate(p.desc, :length => 16)
                    .product-meta
                      %span.product-time
                        %i.fa.fa-clock-o
                        8 days 47 h
                      %ul.product-price-list
                        %li
                          %span.product-price $102
                        %li
                          %span.product-old-price $188
                    %p.product-location
                      %i.fa.fa-map-marker
                      Boston
          .col-lg-12.col-md-12.col-sm-12
            = will_paginate @products, renderer: BootstrapPagination::Rails